rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ─── Helper Functions ─────────────────────────────────
    function isAuthenticated() {
      return request.auth != null;
    }

    function isAdmin() {
      return isAuthenticated() && request.auth.token.role == 'admin';
    }

    function isModerator() {
      return isAuthenticated() && request.auth.token.role == 'moderator';
    }

    function isAdminOrMod() {
      return isAdmin() || isModerator();
    }

    function isOwner(uid) {
      return isAuthenticated() && request.auth.uid == uid;
    }

    function hasModPermission(perm) {
      return isModerator() && request.auth.token.permissions[perm] == true;
    }

    // ─── Users ────────────────────────────────────────────
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow create: if isOwner(userId);
      allow update: if isOwner(userId) || isAdmin();
      allow delete: if isAdmin();
    }

    // ─── Usernames (reservation) ──────────────────────────
    match /usernames/{username} {
      allow read: if true;
      allow create: if isAuthenticated();
      allow delete: if isAdmin();
    }

    // ─── Courses ──────────────────────────────────────────
    match /courses/{courseId} {
      allow read: if true;
      allow write: if isAdmin() || hasModPermission('canManageCourses');
    }

    // ─── Topics ───────────────────────────────────────────
    match /topics/{topicId} {
      allow read: if true;
      allow write: if isAdmin() || hasModPermission('canManageTopics');
    }

    // ─── Notes ────────────────────────────────────────────
    match /notes/{noteId} {
      allow read: if resource.data.isPublic == true || isOwner(resource.data.creatorId) || isAdminOrMod();
      allow create: if isAuthenticated();
      allow update: if isOwner(resource.data.creatorId) || isAdmin() || hasModPermission('canManageNotes');
      allow delete: if isOwner(resource.data.creatorId) || isAdmin() || hasModPermission('canManageNotes');
    }

    // ─── Public Questions ─────────────────────────────────
    match /questions_public/{questionId} {
      allow read: if isAuthenticated();
      allow create: if isAdminOrMod();
      allow update: if isAdmin() || hasModPermission('canManageQuestions');
      allow delete: if isAdmin() || hasModPermission('canManageQuestions');
    }

    // ─── User Private Questions ───────────────────────────
    match /users/{userId}/questions/{questionId} {
      allow read, write: if isOwner(userId);
    }

    // ─── Private Questions (top-level) ────────────────────
    match /questions_private/{questionId} {
      allow read: if isOwner(resource.data.creatorId) || isAdminOrMod();
      allow create: if isAuthenticated();
      allow update: if isOwner(resource.data.creatorId) || isAdmin() || hasModPermission('canReviewQuestions');
      allow delete: if isOwner(resource.data.creatorId);
    }

    // ─── Review Queue ─────────────────────────────────────
    match /review_queue/{requestId} {
      allow read: if isAdminOrMod();
      allow create: if isAuthenticated();
      allow update: if isAdmin() || hasModPermission('canReviewQuestions');
      allow delete: if isAdmin();
    }

    // ─── Sessions ─────────────────────────────────────────
    match /sessions/{sessionId} {
      allow read: if isOwner(resource.data.userId) || isAdminOrMod();
      allow create: if isAuthenticated();
      allow update: if isOwner(resource.data.userId);
      allow delete: if isOwner(resource.data.userId) || isAdmin();
    }

    // ─── Exam Sessions (Practice) ─────────────────────────
    match /exam_sessions/{sessionId} {
      allow read: if isOwner(resource.data.userId) || isAdminOrMod();
      allow create: if isAuthenticated();
      allow update: if isOwner(resource.data.userId);
      allow delete: if isOwner(resource.data.userId) || isAdmin();
    }

    // ─── Attempts ─────────────────────────────────────────
    match /attempts/{attemptId} {
      allow read: if isOwner(resource.data.userId) || isAdminOrMod();
      allow create: if isAuthenticated();
    }

    // ─── Labs ─────────────────────────────────────────────
    match /labs/{labId} {
      allow read: if true;
      allow write: if isAdmin() || hasModPermission('canManageLabs');
    }

    // ─── Lab Sessions ─────────────────────────────────────
    match /lab_sessions/{sessionId} {
      allow read: if isOwner(resource.data.userId) || isAdminOrMod();
      allow create: if isAuthenticated();
      allow update: if isOwner(resource.data.userId);
    }

    // ─── User Stats ───────────────────────────────────────
    match /user_stats/{userId} {
      allow read: if isOwner(userId) || isAdminOrMod();
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
    }

    // ─── Course Stats ─────────────────────────────────────
    match /course_stats/{courseId} {
      allow read: if true;
      allow write: if false; // Only Cloud Functions write here
    }

    // ─── Daily Summaries ──────────────────────────────────
    match /daily_summaries/{summaryId} {
      allow read: if isAuthenticated();
      allow write: if false; // Only Cloud Functions
    }

    // ─── Activity Events ──────────────────────────────────
    match /activity_events/{eventId} {
      allow read: if isAdminOrMod();
      allow create: if isAuthenticated();
    }

    // ─── Audit Log ────────────────────────────────────────
    match /audit_log/{logId} {
      allow read: if isAdmin();
      allow create: if isAdminOrMod();
    }

    // ─── Audit Logs (alias used by activity.ts) ───────────
    match /audit_logs/{logId} {
      allow read: if isAdmin();
      allow create: if isAuthenticated();
    }

    // ─── Announcements ────────────────────────────────────
    match /announcements/{announcementId} {
      allow read: if true;
      allow write: if isAdmin() || hasModPermission('canManageAnnouncements');
    }

    // ─── Feature Flags ────────────────────────────────────
    match /feature_flags/{flagId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // ─── Practice Settings ────────────────────────────────
    match /practice_settings/{courseId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // ─── Site Settings ────────────────────────────────────
    match /site_settings/{doc} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    // ─── Site Content (CMS) ───────────────────────────────
    match /site_content/{doc} {
      allow read: if true;
      allow write: if isAdmin()
        || (doc == 'home' && hasModPermission('siteContentEditHome'))
        || (doc == 'nav' && hasModPermission('siteContentEditNav'))
        || (doc == 'footer' && hasModPermission('siteContentEditFooter'));
    }

    // ─── Site Content Versions (history) ──────────────────
    match /site_content_versions/{versionId} {
      allow read: if isAdmin()
        || hasModPermission('siteContentViewHistory');
      allow create: if isAdmin()
        || hasModPermission('siteContentEditHome')
        || hasModPermission('siteContentEditNav')
        || hasModPermission('siteContentEditFooter');
      allow delete: if isAdmin();
    }

    // ─── Supporter Tiers ──────────────────────────────────
    match /supporter_tiers/{tierId} {
      allow read: if true;
      allow write: if isAdmin();
    }
  }
}
